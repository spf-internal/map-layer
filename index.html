<!DOCTYPE html>
<html>
<head>
  <title>Singapore Police NPC Boundaries</title>
  <meta charset="utf-8" />
  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100%; }

    .control-box {
      background: white;
      padding: 10px;
      margin: 10px;
      border-radius: 6px;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .color-box {
      display: inline-block;
      width: 14px;
      height: 14px;
      background: #0047AB;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
async function initMap() {

  // 1. Create map
  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 1.3521, lng: 103.8198 },
    zoom: 11
  });

  const datasetId = "d_89b44df21fccc4f51390eaff16aa1fe8";
  const pollUrl = `https://api-open.data.gov.sg/v1/public/api/datasets/${datasetId}/poll-download`;

  const bounds = new google.maps.LatLngBounds();
  const labelMarkers = [];

  try {
    // 2. Poll-download
    let res = await fetch(pollUrl);
    const pollData = await res.json();
    if (pollData.code !== 0) throw new Error(pollData.errMsg);

    // 3. Fetch GeoJSON
    res = await fetch(pollData.data.url);
    const geoJson = await res.json();

    // 4. Add GeoJSON (CRITICAL STEP)
    map.data.addGeoJson(geoJson);

    // 5. Style polygons
    map.data.setStyle({
      fillColor: "#0047AB",
      fillOpacity: 0.25,
      strokeColor: "#0047AB",
      strokeWeight: 2
    });

    // 6. Safely extend bounds + compute centroids
    map.data.forEach(feature => {
      const coords = [];
      collectLatLng(feature.getGeometry(), coords);

      // Extend bounds
      coords.forEach(c => bounds.extend(c));

      // Compute centroid
      let lat = 0, lng = 0;
      coords.forEach(c => {
        lat += c.lat();
        lng += c.lng();
      });

      const center = {
        lat: lat / coords.length,
        lng: lng / coords.length
      };

      const name =
        feature.getProperty("name") ||
        feature.getProperty("npc_name") ||
        "NPC";

      // Label marker
      const marker = new google.maps.Marker({
        position: center,
        map: map,
        label: {
          text: name,
          fontSize: "12px",
          fontWeight: "bold"
        },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 0
        }
      });

      labelMarkers.push(marker);
    });

    // 7. Fit map to NPC boundaries
    map.fitBounds(bounds);

  } catch (err) {
    console.error("NPC load error:", err);
  }

  // ðŸ”˜ Toggle
  const toggleDiv = document.createElement("div");
  toggleDiv.className = "control-box";
  toggleDiv.innerHTML = `
    <label>
      <input type="checkbox" id="toggleNpc" checked>
      Show NPC Boundaries
    </label>
  `;
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(toggleDiv);

  document.getElementById("toggleNpc").addEventListener("change", e => {
    map.data.setMap(e.target.checked ? map : null);
    labelMarkers.forEach(m => m.setMap(e.target.checked ? map : null));
  });

  // ðŸ§­ Legend
  const legend = document.createElement("div");
  legend.className = "control-box";
  legend.innerHTML = `
    <b>Legend</b><br>
    <span class="color-box"></span> Neighbourhood Police Centre
  `;
  map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(legend);
}

// ðŸ” Recursive geometry handler (Polygon + MultiPolygon safe)
function collectLatLng(geometry, arr) {
  if (geometry instanceof google.maps.Data.Point) {
    arr.push(geometry.get());
  } else if (geometry instanceof google.maps.Data.MultiPoint ||
             geometry instanceof google.maps.Data.LineString ||
             geometry instanceof google.maps.Data.LinearRing) {
    geometry.getArray().forEach(g => collectLatLng(g, arr));
  } else if (geometry instanceof google.maps.Data.Polygon ||
             geometry instanceof google.maps.Data.MultiPolygon) {
    geometry.getArray().forEach(g => collectLatLng(g, arr));
  }
}
</script>

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRHYlg2978t2LjP6o4mirP3kUD_GylLgA&callback=initMap"
  async defer>
</script>

</body>
</html>
