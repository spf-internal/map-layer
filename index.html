<!DOCTYPE html>
<html>
<head>
  <title>Singapore Police NPC Boundaries</title>
  <meta charset="utf-8" />
  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100%; }

    .control-box {
      background: white;
      padding: 10px;
      margin: 10px;
      border-radius: 6px;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .color-box {
      display: inline-block;
      width: 14px;
      height: 14px;
      background: #0047AB;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
function initMap() {
  // 1. Initialise map
  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 1.3521, lng: 103.8198 },
    zoom: 11
  });

  // ðŸ” LOAD NPCs FROM CLOUDFLARE WORKER
  const GEOJSON_PROXY_URL = "https://npc-geojson-proxy.seixiang232.workers.dev";
  map.data.loadGeoJson(GEOJSON_PROXY_URL);
  map.data.addListener("addfeature", e => {
    if (!e.feature.getProperty("NPC_NAME")) {
      map.data.remove(e.feature);
    }
  });
  
  // 2. Style NPC polygons
  map.data.setStyle({
    fillColor: "#0047AB",
    fillOpacity: 1,
    strokeColor: "#0047AB",
    strokeWeight: 5
  });

  // 3. Fit map to NPC bounds
  const bounds = new google.maps.LatLngBounds();
  map.data.addListener("addfeature", e => {
    collectLatLng(e.feature.getGeometry(), bounds);
  });

  // ðŸ”‘ Wait until ALL feature are loaded
  map.data.addListener("addfeature", () => {
    if (!bounds.isEmpty()) {
      map.fitBounds(bounds);
    }
  });
  
  // 4. Click popup
  const infoWindow = new google.maps.InfoWindow();

  map.data.addListener("click", event => {
    const name =
      event.feature.getProperty("NPC_NAME") ||
      "NIL";

    infoWindow.setContent(`<b>NPC Name:</b> ${name}`);
    infoWindow.setPosition(event.latLng);
    infoWindow.open(map);
  });

  // 5. Toggle control
  const toggleDiv = document.createElement("div");
  toggleDiv.className = "control-box";
  toggleDiv.innerHTML = `
    <label>
      <input type="checkbox" checked>
      Show NPC Boundaries
    </label>
  `;
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(toggleDiv);
  
  // âœ… Attach listener correctly
  const checkbox = toggleDiv.querySelector("input");
  checkbox.addEventListener("change", e => {
    map.data.setMap(e.target.checked ? map : null);
  });

  // 6. Legend
  const legend = document.createElement("div");
  legend.className = "control-box";
  legend.innerHTML = `
    <b>Legend</b><br>
    <span class="color-box"></span> Neighbourhood Police Centre
  `;
  map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(legend);
}

// ðŸ” Recursive geometry handler (Polygon + MultiPolygon safe)
function collectLatLng(geometry, bounds) {
  // Point
  if (geometry instanceof google.maps.Data.Point) {
    bounds.extend(geometry.get());
    return;
  }

  // LineString or LinearRing
  if (
    geometry instanceof google.maps.Data.LineString ||
    geometry instanceof google.maps.Data.LinearRing
  ) {
    geometry.getArray().forEach(latlng => bounds.extend(latlng));
    return;
  }

  // Polygon
  if (geometry instanceof google.maps.Data.Polygon) {
    geometry.getArray().forEach(ring => {
      ring.getArray().forEach(latlng => bounds.extend(latlng));
    });
    return;
  }

  // MultiPolygon
  if (geometry instanceof google.maps.Data.MultiPolygon) {
    geometry.getArray().forEach(polygon => {
      polygon.getArray().forEach(ring => {
        ring.getArray().forEach(latlng => bounds.extend(latlng));
      });
    });
    return;
  }
}

window.initMap = initMap;
</script>

<!-- ðŸ”‘ Google Maps API -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRHYlg2978t2LjP6o4mirP3kUD_GylLgA&callback=initMap&loading=async"
  async>
</script>

</body>
</html>
