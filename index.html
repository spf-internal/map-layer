<!DOCTYPE html>
<html>
<head>
  <title>Singapore Police NPC & Establishments</title>
  <meta charset="utf-8" />
  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100%; }

    .control-box {
      background: white;
      padding: 10px;
      margin: 10px;
      border-radius: 6px;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .legend-row {
      margin-top: 6px;
    }
    
    .color-box {
      display: inline-block;
      width: 14px;
      height: 14px;
      background: #0047AB;
      margin-right: 6px;
      vertical-align: middle;
    }

    .npc { background: #0047AB; }
    .est { background: #D32F2F; border-radius: 50%; }
  </style>
</head>

<body>
<div id="map"></div>

<script>
function initMap() {
  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 1.3521, lng: 103.8198 },
    zoom: 11
  });
  const bounds = new google.maps.LatLngBounds();
  const infoWindow = new google.maps.InfoWindow();

  // NPC POLYGON LAYER
  const npcLayer = new google.maps.Data({ map });
  const NPC_GEOJSON_PROXY_URL = "https://npc-geojson-proxy.seixiang232.workers.dev/";
  npcLayer.loadGeoJson(
    NPC_GEOJSON_PROXY_URL, null, features => {
      features.forEach(f =>
        collectLatLng(f.getGeometry(), bounds)
      );
      // map.fitBounds(bounds);
    }
  );
  
  npcLayer.setStyle({
    fillColor: "#0047AB",
    fillOpacity: 0.6,
    strokeColor: "#0047AB",
    strokeWeight: 2
  });

  npcLayer.addListener("click", e => {
    infoWindow.setContent(
      `<b>NPC:</b> ${e.feature.getProperty("NPC_NAME") || "NIL"}`
    );
    infoWindow.setPosition(e.latLng);
    infoWindow.open(map);
  });

  // ESTABLISHMENTS POINT LAYER
  const estLayer = new google.maps.Data({ map });
  const ESTABLISHMENTS_GEOJSON_PROXY_URL = "https://establishments-geojson-proxy.seixiang232.workers.dev/";
  
  estLayer.loadGeoJson(
    ESTABLISHMENTS_GEOJSON_PROXY_URL
  );

  estLayer.setStyle({
    icon: {
      path: google.maps.SymbolPath.CIRCLE,
      scale: 5,
      fillColor: "#D32F2F",
      fillOpacity: 1,
      strokeWeight: 1,
      strokeColor: "#ffffff"
    }
  });

  estLayer.addListener("click", e => {
    const props = e.feature;
    
    infoWindow.setContent(`
      <div style="max-height: 250px; overflow-y: auto; font-size: 13px;">
        <b>Establishment Info</b><br>
        <table style="border-collapse: collapse; width: 100%;">
          // <tr><td><b>OBJECTID_1</b></td><td>${props.getProperty("OBJECTID_1") || "NIL"}</td></tr>
          <tr><td><b>DEPARTMENT</b></td><td>${props.getProperty("DEPARTMENT") || "NIL"}</td></tr>
          <tr><td><b>TYPE</b></td><td>${props.getProperty("TYPE") || "NIL"}</td></tr>
          <tr><td><b>OPERATING_HOURS</b></td><td>${props.getProperty("OPERATING_HOURS") || "NIL"}</td></tr>
          <tr><td><b>TELEPHONE</b></td><td>${props.getProperty("TELEPHONE") || "NIL"}</td></tr>
          <tr><td><b>ALT_TELEPHONE_LINE</b></td><td>${props.getProperty("ALT_TELEPHONE_LINE") || "NIL"}</td></tr>
          <tr><td><b>BUILDING_NAME</b></td><td>${props.getProperty("BUILDING_NAME") || "NIL"}</td></tr>
          <tr><td><b>HSE_BLK_NO</b></td><td>${props.getProperty("HSE_BLK_NO") || "NIL"}</td></tr>
          <tr><td><b>UNIT</b></td><td>${props.getProperty("UNIT") || "NIL"}</td></tr>
          <tr><td><b>STREET_NAME</b></td><td>${props.getProperty("STREET_NAME") || "NIL"}</td></tr>
          <tr><td><b>POSTAL_CODE</b></td><td>${props.getProperty("POSTAL_CODE") || "NIL"}</td></tr>
          <tr><td><b>FAX</b></td><td>${props.getProperty("FAX") || "NIL"}</td></tr>
          <tr><td><b>INC_CRC</b></td><td>${props.getProperty("INC_CRC") || "NIL"}</td></tr>
          <tr><td><b>FMEL_UPD_D</b></td><td>${props.getProperty("FMEL_UPD_D") || "NIL"}</td></tr>
        </table>
      </div>
    `);
    infoWindow.setPosition(e.latLng);
    infoWindow.open(map);
  });
  
  // TOGGLE CONTROLS
  const toggleDiv = document.createElement("div");
  toggleDiv.className = "control-box";
  toggleDiv.innerHTML = `
    <label>
      <input type="checkbox" checked id="npcToggle">
      Show SPF NPC Boundaries
    </label><br>
    <label>
      <input type="checkbox" checked id="estToggle">
      Show SPF Establishments
    </label>
  `;
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(toggleDiv);
  
  const npcToggle = toggleDiv.querySelector("#npcToggle");
  const estToggle = toggleDiv.querySelector("#estToggle");
  
  npcToggle.onchange = e => npcLayer.setMap(e.target.checked ? map : null);
  estToggle.onchange = e => estLayer.setMap(e.target.checked ? map : null);

  // LEGEND
  const legend = document.createElement("div");
  legend.className = "control-box";
  legend.innerHTML = `
    <b>Legend</b>
    <div class="legend-row">
      <span class="color-box npc"></span> NPC Boundary
    </div>
    <div class="legend-row">
      <span class="color-box est"></span> Establishment
    </div>
  `;
  map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(legend);
}

// GEOMETRY BOUNDS HELPER
function collectLatLng(geometry, bounds) {
  // Point
  if (geometry instanceof google.maps.Data.Point) {
    bounds.extend(geometry.get());
    return;
  }

  // LineString or LinearRing
  if (
    geometry instanceof google.maps.Data.LineString ||
    geometry instanceof google.maps.Data.LinearRing
  ) {
    geometry.getArray().forEach(latlng => bounds.extend(latlng));
    return;
  }

  // Polygon
  if (geometry instanceof google.maps.Data.Polygon) {
    geometry.getArray().forEach(ring => {
      ring.getArray().forEach(latlng => bounds.extend(latlng));
    });
    return;
  }

  // MultiPolygon
  if (geometry instanceof google.maps.Data.MultiPolygon) {
    geometry.getArray().forEach(polygon => {
      polygon.getArray().forEach(ring => {
        ring.getArray().forEach(latlng => bounds.extend(latlng));
      });
    });
    return;
  }
}

window.initMap = initMap;
</script>

<!-- ðŸ”‘ Google Maps API -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRHYlg2978t2LjP6o4mirP3kUD_GylLgA&callback=initMap&loading=async"
  async defer>
</script>

</body>
</html>
