<!DOCTYPE html>
<html>
<head>
  <title>Singapore Police NPC & Establishments</title>
  <meta charset="utf-8" />
  <style>
    body { margin: 0; }
    #map { height: 100vh; width: 100%; }

    .control-box {
      background: white;
      padding: 10px;
      margin: 10px;
      border-radius: 6px;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .legend-row {
      margin-top: 6px;
    }
    
    .color-box {
      display: inline-block;
      width: 14px;
      height: 14px;
      background: #0047AB;
      margin-right: 6px;
      vertical-align: middle;
    }

    .npc-boundary { background: #0047AB; } /* Blue */
    .npc { background: #0047AB; border-radius: 50%; } /* Blue */
    .npp { background: #4CAF50; border-radius: 50%; } /* Green */
    .est { background: #FFA500; border-radius: 50%; } /* Orange */
    .closed { background: #D32F2F; border-radius: 50%; } /* Red */
    
    /* InfoWindow Table Styles */
    .info-window {
      max-height: 250px;
      overflow-y: auto;
      font-size: 13px;
      font-family: Arial, sans-serif;
    }
  
    .info-window b {
      font-size: 14px;
      margin-bottom: 5px;
      display: block;
    }
  
    .info-table {
      border-collapse: collapse;
      width: 100%;
      min-width: 300px;
      text-align: left;
    }
  
    .info-table thead tr {
      background-color: #f0f0f0;
      position: sticky;
      top: 0;
    }
  
    .info-table th, .info-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
    }
  
    .info-table td:first-child {
      font-weight: bold;
    }
  
    .info-table tbody tr:nth-child(even) {
      background-color: #f9f9f9;
    }
  
    .info-table tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }
  </style>
</head>

<body>
<div id="map"></div>

<script>
function initMap() {
  const map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 1.3521, lng: 103.8198 },
    zoom: 11
  });
  const bounds = new google.maps.LatLngBounds();
  const infoWindow = new google.maps.InfoWindow();
  const hoverInfoWindow = new google.maps.InfoWindow({
    disableAutoPan: true
  });
  let hoveredFeature = null;
  let hoverCloseTimer = null;

  // NPC POLYGON LAYER
  const npcLayer = new google.maps.Data({ map });
  const NPC_GEOJSON_PROXY_URL = "https://npc-geojson-proxy.seixiang232.workers.dev/";
  npcLayer.loadGeoJson(
    NPC_GEOJSON_PROXY_URL, null, features => {
      features.forEach(f =>
        collectLatLng(f.getGeometry(), bounds)
      );
      // map.fitBounds(bounds);
    }
  );
  
  npcLayer.setStyle({
    fillColor: "#0047AB",
    fillOpacity: 0.6,
    strokeColor: "#0047AB",
    strokeWeight: 2
  });

  npcLayer.addListener("click", e => {
    const props = e.feature;
    infoWindow.setContent(buildNPCBoundaryPopUpContent(props));
    infoWindow.setPosition(e.latLng);
    infoWindow.open(map);
  });

  npcLayer.addListener("mouseover", e => {
    map.getDiv().style.cursor = "pointer";
    const props = e.feature;
    hoverInfoWindow.setContent(buildNPCBoundaryPopUpContent(props));
    hoverInfoWindow.setPosition(e.latLng);
    hoverInfoWindow.open(map);
  });

  npcLayer.addListener("mouseout", () => {
    map.getDiv().style.cursor = "";
    hoverInfoWindow.close();
  });

  // ESTABLISHMENTS POINT LAYER
  const estLayer = new google.maps.Data({ map });
  const ESTABLISHMENTS_GEOJSON_PROXY_URL = "https://establishments-geojson-proxy.seixiang232.workers.dev/";
  
  estLayer.loadGeoJson(
    ESTABLISHMENTS_GEOJSON_PROXY_URL
  );

  estLayer.setStyle(feature => {
    const department = feature.getProperty("DEPARTMENT") || "";
    const isNPC = department.includes("Neighbourhood Police Centre");
    const isNPP = department.includes("Neighbourhood Police Post");
    const isClosed = department.includes("Closed");

    let fillColor = "#FFA500"; // default: orange
    if (isNPC) fillColor = "#0047AB";   // blue
    if (isNPP) fillColor = "#4CAF50"; // green
    if (isClosed) fillColor = "#D32F2F"; // red
    
    return {
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: fillColor,
        fillOpacity: 1,
        strokeWeight: 1,
        strokeColor: "#ffffff"
      }
    };
  });

  estLayer.addListener("click", e => {
    const props = e.feature;
    infoWindow.setContent(buildEstablishmentPopUpContent(props));
    infoWindow.setPosition(e.latLng);
    infoWindow.open(map);
  });

  estLayer.addListener("mouseover", e => {
    map.getDiv().style.cursor = "pointer";

    // cancel pending close
    if (hoverCloseTimer) {
      clearTimeout(hoverCloseTimer);
      hoverCloseTimer = null;
    }
    // same feature â†’ do nothing
    if (hoveredFeature === e.feature) return;
    hoveredFeature = e.feature;
    
    const props = e.feature;
    hoverInfoWindow.setContent(buildEstablishmentPopUpContent(props));
    hoverInfoWindow.setPosition(e.latLng);
    hoverInfoWindow.open(map);
  });

  estLayer.addListener("mouseout", () => {
    map.getDiv().style.cursor = "";

    // delay close to prevent flicker
    hoverCloseTimer = setTimeout(() => {
      hoverInfoWindow.close();
      hoveredFeature = null;
    }, 120);
  });

  // TOGGLE CONTROLS
  const toggleDiv = document.createElement("div");
  toggleDiv.className = "control-box";
  toggleDiv.innerHTML = `
    <b>Filter</b><br>
    <label>
      <input type="checkbox" checked id="npcToggle">
      Show SPF NPC Boundaries
    </label><br>
    <label>
      <input type="checkbox" checked id="estToggle">
      Show SPF Establishments
    </label>
  `;
  map.controls[google.maps.ControlPosition.TOP_LEFT].push(toggleDiv);
  
  const npcToggle = toggleDiv.querySelector("#npcToggle");
  const estToggle = toggleDiv.querySelector("#estToggle");
  
  npcToggle.onchange = e => npcLayer.setMap(e.target.checked ? map : null);
  estToggle.onchange = e => estLayer.setMap(e.target.checked ? map : null);

  // LEGEND
  const legend = document.createElement("div");
  legend.className = "control-box";
  legend.innerHTML = `
    <b>Legend</b>
    <div class="legend-row">
      <span class="color-box npc-boundary"></span> Neighbourhood Police Centres (NPCs) Boundary
    </div>
    <div class="legend-row">
      <span class="color-box npc"></span> Neighbourhood Police Centres (NPCs)
    </div>
    <div class="legend-row">
      <span class="color-box npp"></span> Neighbourhood Police Post (NPP)
    </div>
    <div class="legend-row">
      <span class="color-box est"></span> Other Establishments
    </div>
    <div class="legend-row">
      <span class="color-box closed"></span> Closed Establishments
    </div>
  `;
  map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(legend);
}

// GEOMETRY BOUNDS HELPER
function collectLatLng(geometry, bounds) {
  // Point
  if (geometry instanceof google.maps.Data.Point) {
    bounds.extend(geometry.get());
    return;
  }

  // LineString or LinearRing
  if (
    geometry instanceof google.maps.Data.LineString ||
    geometry instanceof google.maps.Data.LinearRing
  ) {
    geometry.getArray().forEach(latlng => bounds.extend(latlng));
    return;
  }

  // Polygon
  if (geometry instanceof google.maps.Data.Polygon) {
    geometry.getArray().forEach(ring => {
      ring.getArray().forEach(latlng => bounds.extend(latlng));
    });
    return;
  }

  // MultiPolygon
  if (geometry instanceof google.maps.Data.MultiPolygon) {
    geometry.getArray().forEach(polygon => {
      polygon.getArray().forEach(ring => {
        ring.getArray().forEach(latlng => bounds.extend(latlng));
      });
    });
    return;
  }
}

// NPC Boundary PopUp Content
function buildNPCBoundaryPopUpContent(props) {
  return `
    <div class="info-window">
      <h2>Establishment Info:</h2>
      <table class="info-table">
        <thead>
          <tr>
            <th>Field</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          ${[
            ["OBJECTID", props.getProperty("OBJECTID")],
            ["NPC_NAME", props.getProperty("NPC_NAME")],
            ["DIVISION", props.getProperty("DIVISION")],
            ["DIV", props.getProperty("DIV")],
            ["INC_CRC", props.getProperty("INC_CRC")],
            ["FMEL_UPD_D", props.getProperty("FMEL_UPD_D")]
          ].map(([field, value]) => `
            <tr>
              <td>${field}</td>
              <td>${value || 'NIL'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `
}

// Establishment PopUp Content
function buildEstablishmentPopUpContent(props) {
  return `
    <div class="info-window">
      <h2>Establishment Info:</h2>
      <table class="info-table">
        <thead>
          <tr>
            <th>Field</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          ${[
            ["OBJECTID_1", props.getProperty("OBJECTID_1")],
            ["DEPARTMENT", props.getProperty("DEPARTMENT")],
            ["TYPE", props.getProperty("TYPE")],
            ["OPERATING_HOURS", props.getProperty("OPERATING_HOURS")],
            ["TELEPHONE", props.getProperty("TELEPHONE")],
            ["ALT_TELEPHONE_LINE", props.getProperty("ALT_TELEPHONE_LINE")],
            ["BUILDING_NAME", props.getProperty("BUILDING_NAME")],
            ["HSE_BLK_NO", props.getProperty("HSE_BLK_NO")],
            ["UNIT", props.getProperty("UNIT")],
            ["STREET_NAME", props.getProperty("STREET_NAME")],
            ["POSTAL_CODE", props.getProperty("POSTAL_CODE")],
            ["FAX", props.getProperty("FAX")],
            ["INC_CRC", props.getProperty("INC_CRC")],
            ["FMEL_UPD_D", props.getProperty("FMEL_UPD_D")]
          ].map(([field, value]) => `
            <tr>
              <td>${field}</td>
              <td>${value || 'NIL'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `
}

window.initMap = initMap;
</script>

<!-- ðŸ”‘ Google Maps API -->
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCRHYlg2978t2LjP6o4mirP3kUD_GylLgA&callback=initMap&loading=async"
  async defer>
</script>

</body>
</html>
